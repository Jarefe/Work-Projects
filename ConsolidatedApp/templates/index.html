<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Consolidated Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <style>
    body {
        font-family: Arial, sans-serif;
        margin: 2rem;
        background-color: #f4f4f4;
    }
    h1 {
        text-align: center;
    }
    .section {
        background-color: white;
        padding: 20px;
        margin-bottom: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    form {
        margin-top: 10px;
    }
    input[type="file"], textarea {
        width: 100%;
        margin-bottom: 10px;
    }
    button {
        padding: 10px 15px;
        background-color: #007BFF;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    button:hover {
        background-color: #0056b3;
    }
    iframe {
        width: 100%;
        height: 800px;
        border: none;
        margin-top: 20px;
    }
    #scraper-output p {
        margin-bottom: 0.5em;
    }
    #scraper-output a {
        color: #007BFF;
        text-decoration: none;
    }
    #scraper-output a:hover {
        text-decoration: underline;
    }
    details summary {
        cursor: pointer;
        font-weight: bold;
        margin-top: 10px;
    }
    pre {
        background: #f0f0f0;
        padding: 10px;
        max-height: 300px;
        overflow-y: auto;
    }

    /* üîΩ New Drag & Drop Styles üîΩ */
    #drop-area {
        border: 2px dashed #007BFF;
        padding: 20px;
        text-align: center;
        background-color: #f9f9f9;
        cursor: pointer;
        border-radius: 6px;
        transition: background-color 0.2s ease-in-out;
    }

    #drop-area.hover {
        background-color: #e0f0ff;
    }
</style>

</head>
<body>

<h1>All-In-One Dashboard</h1>

<!-- Section 1: Excel Formatter -->
<div class="section">
    <h2>üìÅ Excel Formatter</h2>
    <p>Upload a raw Excel file. It will automatically be formatted and downloaded.</p>
    <p>Note: for the moment, this is only for formatting testing reports.</p>

    <form method="POST" action="/format-excel" enctype="multipart/form-data" id="excel-form">
        <div id="drop-area">
            <p>Drag & Drop file here or click to select</p>
            <input type="file" name="file" id="excel-file" required hidden>
        </div>
        <button type="submit" style="margin-top: 10px;">Format and Download</button>
    </form>
</div>


<!-- Section 2: eBay Scraper -->
<div class="section">
    <h2>üîç eBay Scraper</h2>
    <p>Enter search parameters to scrape <u>sold</u> eBay listings (e.g., model, SKU).</p>
    <form id="scraper-form">
        <textarea name="query" placeholder="Enter search string..." rows="3" required></textarea>
        <label for="page-count"><strong>Number of Pages to Scrape:</strong></label>
        <input type="number" id="page-count" name="pages" min="1" max="10" value="2" style="width: 30px; margin-bottom: 10px;">
        <br>
        <button type="submit">Scrape eBay</button>
    </form>
    <div id="scraper-output" style="margin-top: 20px;"></div>
</div>


<!-- Section 3: Dash Pricing Dashboard -->
<div class="section">
    <h2>üìä Pricing Dashboard</h2>
    <p>Explore financial summaries and profit metrics from historical pricing data.</p>

    <form id="pricing-history-form">
        <label><strong>Upload Pricing History Excel File:</strong></label>
        <input type="file" name="pricing_file" required>
        <button type="submit">Upload Pricing History</button>
    </form>

<!--    <form id="product-inventory-form" style="margin-top: 20px;">-->
<!--        <label><strong>Upload Product Inventory Excel File:</strong></label>-->
<!--        <input type="file" name="product_file" required>-->
<!--        <button type="submit">Upload Product Inventory File</button>-->
<!--    </form>-->

    <div id="pricing-upload-output" style="margin-top: 10px;"></div>

    <iframe id="dash-frame" src="/dash/"></iframe>

    <hr style="margin: 20px 0;">
</div>

<!-- JS: eBay Scraper -->
<script>
    document.getElementById("scraper-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        const query = e.target.query.value;
        const pageCount = e.target.pages.value;

        const bodyData = JSON.stringify({
            query: query,
            pages: parseInt(pageCount) || 2
        });

        const outputDiv = document.getElementById("scraper-output");

        try {
            const response = await fetch("/scrape-ebay", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: bodyData
            });

            const result = await response.json();

            if (result.results) {
                outputDiv.innerHTML = `
                    <h3>Results:</h3>
                    <p><strong>Average Price:</strong> $${result.results["average price"].toFixed(2)}</p>
                    <p><strong>Highest Price:</strong> $${result.results["highest price"]}</p>
                    <p><strong>Lowest Price:</strong> $${result.results["lowest price"]}</p>
                    <p><strong>Total Listings Analyzed:</strong> ${result.results["prices"].length}</p>
                    <p><a href="${result.results.url}" target="_blank">üîó View eBay Search Results</a></p>
                    <details>
                        <summary>Show All Prices</summary>
                        <pre>${JSON.stringify(result.results.prices, null, 2)}</pre>
                    </details>
                `;
            } else if (result.error) {
                outputDiv.innerHTML = `<p style="color: red;">Error: ${result.error}</p>`;
            }
        } catch (err) {
            outputDiv.innerHTML = `<p style="color: red;">Error: ${err.message}</p>`;
        }
    });
</script>


<!-- JS: Pricing Dashboard File Uploads -->
<script>
    document.getElementById("pricing-history-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData();
        const fileInput = e.target.querySelector("input[type='file']");
        const outputDiv = document.getElementById("pricing-upload-output");

        if (fileInput.files.length < 1) {
            outputDiv.innerHTML = "<p style='color: red;'>Please select a pricing history file.</p>";
            return;
        }

        formData.append("file", fileInput.files[0]);

        try {
            const response = await fetch("/upload-pricing-history", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                outputDiv.innerHTML = "<p style='color: green;'>Pricing history uploaded successfully.</p>";

                // Reload the Dash iframe to reflect updated data
                const iframe = document.getElementById("dash-frame");
                iframe.src = iframe.src;
            } else {
                outputDiv.innerHTML = `<p style='color: red;'>Error: ${result.error}</p>`;
            }
        } catch (err) {
            outputDiv.innerHTML = `<p style='color: red;'>Upload failed: ${err.message}</p>`;
        }
    });

    document.getElementById("product-inventory-form").addEventListener("submit", async function (e) {
        e.preventDefault();
        const formData = new FormData();
        const fileInput = e.target.querySelector("input[type='file']");
        const outputDiv = document.getElementById("pricing-upload-output");

        if (fileInput.files.length < 1) {
            outputDiv.innerHTML = "<p style='color: red;'>Please select the second Excel file.</p>";
            return;
        }

        formData.append("file", fileInput.files[0]);

        try {
            const response = await fetch("/upload-second-excel", {
                method: "POST",
                body: formData
            });

            const result = await response.json();

            if (result.success) {
                outputDiv.innerHTML = "<p style='color: green;'>Second Excel file uploaded successfully.</p>";
            } else {
                outputDiv.innerHTML = `<p style='color: red;'>Error: ${result.error}</p>`;
            }
        } catch (err) {
            outputDiv.innerHTML = `<p style='color: red;'>Upload failed: ${err.message}</p>`;
        }
    });
</script>

<script>
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('excel-file');

    // Clicking the drop area opens file dialog
    dropArea.addEventListener('click', () => fileInput.click());

    // Highlight drop area on drag
    ['dragenter', 'dragover'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            dropArea.classList.add('hover');
        });
    });

    // Remove highlight when not dragging
    ['dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, (e) => {
            e.preventDefault();
            dropArea.classList.remove('hover');
        });
    });

    // Handle dropped files
    dropArea.addEventListener('drop', (e) => {
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;  // Attach dropped file to hidden input
        }
    });
</script>


</body>
</html>
